---
- file: path=/github/elasticsearch-cluster state=directory

- git: repo=https://github.com/jaohaohsuan/kubernetes-elasticsearch-cluster.git
       dest=/github/elasticsearch-cluster
       force=yes
       version=a110e244e9d559d990a211253d18d6f8b4fe6f19
  become: yes

- command: "kubectl apply -f {{item}}"
  args:
    chdir: /github/elasticsearch-cluster
  with_items:
    - "service-account.yaml"
    - "es-discovery-svc.yaml"
    - "es-svc.yaml"
    - "es-master-rc.yaml"
  changed_when: false

- shell: |
    kubectl get po | grep es-master
  register: result
  until: "'Running' in result.stdout"
  changed_when: false
  retries: 1000
  delay: 60

- command: kubectl apply -f es-client-rc.yaml
  args:
    chdir: /github/elasticsearch-cluster

- shell: |
    kubectl get po | grep es-client
  register: result
  until: "'Running' in result.stdout"
  changed_when: false
  retries: 1000
  delay: 60

- command: kubectl apply -f es-data-rc.yaml
  args:
    chdir: /github/elasticsearch-cluster